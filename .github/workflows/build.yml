name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Debug - List files before generation
      run: |
        echo "ğŸ“‚ Files before generation:"
        ls -la
        echo "ğŸ“ Scripts folder:"
        ls -la scripts/
      
    - name: Generate Android Project
      run: |
        echo "ğŸ”§ Generating Android project..."
        python scripts/build_app.py
        echo "âœ… Project generation completed"
      
    - name: Debug - Check generated project structure
      run: |
        echo "ğŸ“‚ Project structure after generation:"
        find ScreenshotApp -type f -name "*.kt" -o -name "*.xml" -o -name "*.gradle" | head -20
        echo "ğŸ“ Top level ScreenshotApp:"
        ls -la ScreenshotApp/
        echo "ğŸ“ App folder:"
        ls -la ScreenshotApp/app/ || echo "App folder not found!"
      
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Debug - Check Android SDK
      run: |
        echo "ğŸ“± Android SDK info:"
        which sdkmanager || echo "sdkmanager not found"
        which adb || echo "adb not found"
      
    - name: Build APK with Gradle
      run: |
        cd ScreenshotApp
        echo "ğŸ”¨ Building APK..."
        chmod +x ./gradlew
        ./gradlew tasks --all || echo "Gradle tasks failed"
        ./gradlew assembleDebug --stacktrace --info
        echo "ğŸ” Build result:"
        find . -name "*.apk" -type f || echo "No APK files found"
      
    - name: Upload APK Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: screenshot-app-apk
        path: ScreenshotApp/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: Upload Build Reports
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-reports
        path: |
          ScreenshotApp/app/build/reports/
          ScreenshotApp/build/reports/
        retention-days: 15